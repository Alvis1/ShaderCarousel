<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>TSL Polka Dots Test - A-Frame WebGPU</title>
    <meta name="description" content="TSL Polka Dots with A-Frame WebGPU">
    
    <!-- Import maps for local Three.js WebGPU -->
    <script type="importmap">
    {
        "imports": {
            "aframe": "./components/three/aframe-master.module.min.js",
            "three": "./components/three/super-three.webgpu.js",
            "three/webgpu": "./components/three/super-three.webgpu.js",
            "three/tsl": "./components/three/super-three.tsl.js"
        }
    }
    </script>
    
    <script type="module">
        import AFRAME from 'aframe';
        import * as THREE from 'three';
        import { color, uniform, mix, smoothstep, distance, positionGeometry, float, mul, add, sub, div, pow, oneMinus, exp, mat2, round, If, Loop, min, max, clamp, floor, acos, cos, sin, vec3, mod } from 'three/tsl';
        
        // Set up global THREE for A-Frame compatibility
        const THREE_GLOBAL = {};
        const copyKeys = [...Object.getOwnPropertyNames(THREE), ...Object.getOwnPropertySymbols(THREE)];
        for (const key of copyKeys) {
            const descriptor = Object.getOwnPropertyDescriptor(THREE, key) ?? { enumerable: true };
            Object.defineProperty(THREE_GLOBAL, key, {
                value: THREE[key],
                enumerable: descriptor.enumerable,
                configurable: true,
                writable: true
            });
        }
        window.THREE = THREE_GLOBAL;
        
        // Simple polka dots TSL shader (inline version)
        function createPolkaDotsShader(params = {}) {
            const dotCount = uniform(params.count || 2);
            const dotSize = uniform(params.size || 0.5);
            const dotBlur = uniform(params.blur || 0.25);
            const dotColor = uniform(new THREE.Color(params.color || '#000000'));
            const bgColor = uniform(new THREE.Color(params.background || '#ffffff'));
            
            // Simple 2D polka dots pattern
            const pos = positionGeometry.xy.mul(dotCount);
            const gridPos = pos.round();
            const dist = distance(pos, gridPos).div(dotCount);
            
            const size = exp(dotSize.mul(5).sub(5));
            const blur = dotBlur.pow(4);
            const k = smoothstep(size.sub(blur), size.add(blur), dist);
            
            return mix(dotColor, bgColor, k);
        }
        
        // Register TSL polka dots component
        AFRAME.registerComponent('polka-dots', {
            schema: {
                count: {type: 'number', default: 3},
                size: {type: 'number', default: 0.6},
                blur: {type: 'number', default: 0.22},
                color: {type: 'color', default: '#000000'},
                background: {type: 'color', default: '#ffffff'},
                roughness: {type: 'number', default: 0.2},
                metalness: {type: 'number', default: 0.1}
            },
            
            init() {
                const data = this.data;
                
                // Create TSL material
                const material = new THREE.MeshStandardNodeMaterial({
                    roughness: data.roughness,
                    metalness: data.metalness
                });
                
                // Apply polka dots shader
                material.colorNode = createPolkaDotsShader({
                    count: data.count,
                    size: data.size,
                    blur: data.blur,
                    color: data.color,
                    background: data.background
                });
                
                // Apply to mesh
                const mesh = this.el.getObject3D('mesh');
                if (mesh) {
                    mesh.material = material;
                } else {
                    this.el.addEventListener('object3dset', () => {
                        const newMesh = this.el.getObject3D('mesh');
                        if (newMesh) {
                            newMesh.material = material;
                        }
                    });
                }
            }
        });
    </script>
    
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        
        #info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="info">
        <h3>ðŸŽ¨ TSL Polka Dots Test</h3>
        <p>A-Frame WebGPU + Three.js TSL</p>
        <p>WASD + Mouse to navigate</p>
    </div>

    <a-scene 
        stats 
        background="color: #87CEEB">
        
        <!-- Main polka dots sphere -->
        <a-sphere
            position="0 2 -5"
            radius="2"
            animation="property: rotation; to: 0 360 0; loop: true; dur: 20000"
            polka-dots="count: 4; size: 0.6; blur: 0.2; color: #ff0000; background: #ffffff">
        </a-sphere>
        
        <!-- Test boxes -->
        <a-box 
            position="-3 1 -3" 
            rotation="0 45 0"
            polka-dots="count: 2; size: 0.8; blur: 0.3; color: #000000; background: #ffff00">
        </a-box>
        
        <a-box 
            position="3 1 -3" 
            rotation="0 -45 0"
            polka-dots="count: 6; size: 0.4; blur: 0.1; color: #0066ff; background: #ffffff">
        </a-box>
        
        <!-- Ground -->
        <a-plane 
            position="0 0 0" 
            rotation="-90 0 0" 
            width="20" 
            height="20"
            color="#7BC8A4">
        </a-plane>
        
        <!-- Lighting -->
        <a-light type="ambient" color="#404040" intensity="0.4"></a-light>
        <a-light 
            type="directional" 
            color="#ffffff" 
            intensity="0.8" 
            position="5 5 2">
        </a-light>
        
        <!-- Camera -->
        <a-entity 
            position="0 2 5"
            camera="fov: 50; near: 0.1; far: 100"
            look-controls
            wasd-controls="acceleration: 20">
        </a-entity>
    </a-scene>
</body>
</html>