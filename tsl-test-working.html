<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>TSL Shader Test - A-Frame WebGPU</title>
    <meta name="description" content="Testing TSL Shaders with A-Frame WebGPU">
    
    <!-- Import maps for local Three.js WebGPU -->
    <script type="importmap">
    {
        "imports": {
            "aframe": "./components/three/aframe-master.module.min.js",
            "three": "./components/three/super-three.webgpu.js",
            "three/webgpu": "./components/three/super-three.webgpu.js",
            "three/tsl": "./components/three/super-three.tsl.js"
        }
    }
    </script>
    
    <script type="module">
        import AFRAME from 'aframe';
        import * as THREE from 'three';
        import { color, uniform, mix, smoothstep, distance, positionGeometry, float, mul, add, sub, div, pow, oneMinus, exp, mat2, round, time, cos, sin, vec3, PI2 } from 'three/tsl';
        
        // Set up global THREE for A-Frame compatibility
        const THREE_GLOBAL = {};
        const copyKeys = [...Object.getOwnPropertyNames(THREE), ...Object.getOwnPropertySymbols(THREE)];
        for (const key of copyKeys) {
            const descriptor = Object.getOwnPropertyDescriptor(THREE, key) ?? { enumerable: true };
            Object.defineProperty(THREE_GLOBAL, key, {
                value: THREE[key],
                enumerable: descriptor.enumerable,
                configurable: true,
                writable: true
            });
        }
        window.THREE = THREE_GLOBAL;
        
        // Register TSL material component
        AFRAME.registerComponent('tsl-material', {
            schema: {
                shader: {type: 'string', default: 'polka-dots'},
                count: {type: 'number', default: 3},
                size: {type: 'number', default: 0.6},
                blur: {type: 'number', default: 0.22},
                color: {type: 'color', default: '#000000'},
                background: {type: 'color', default: '#ffffff'},
                roughness: {type: 'number', default: 0.2},
                metalness: {type: 'number', default: 0.1}
            },
            
            init() {
                this.setupMaterial();
            },
            
            async setupMaterial() {
                const data = this.data;
                
                try {
                    let shaderFunction;
                    
                    // For now, let's use a built-in simple shader
                    if (data.shader === 'polka-dots') {
                        shaderFunction = this.createPolkaDotsShader(data);
                    } else if (data.shader === 'galaxy') {
                        shaderFunction = this.createGalaxyShader(data);
                    } else {
                        // Default fallback
                        shaderFunction = this.createSimplePattern(data);
                    }
                    
                    // Create TSL material
                    const material = new THREE.MeshStandardNodeMaterial({
                        roughness: data.roughness,
                        metalness: data.metalness
                    });
                    
                    material.colorNode = shaderFunction;
                    
                    // Apply to mesh
                    this.applyMaterial(material);
                    
                } catch (error) {
                    console.error('Error setting up TSL material:', error);
                }
            },
            
            createPolkaDotsShader(params) {
                const dotCount = uniform(params.count);
                const dotSize = uniform(params.size);
                const dotBlur = uniform(params.blur);
                const dotColor = uniform(new THREE.Color(params.color));
                const bgColor = uniform(new THREE.Color(params.background));
                
                // Simple 2D polka dots using UV coordinates
                const cnt = dotCount.pow(2).sub(0.5);
                const pos = positionGeometry.xy.mul(cnt).mul(mat2(1, 1, -1, 1));
                const posTo = pos.round();
                const dist = distance(pos, posTo).div(cnt);
                
                const size = exp(dotSize.mul(5).sub(5));
                const blur = dotBlur.pow(4);
                const k = smoothstep(size.sub(blur), size.add(blur), dist);
                
                return mix(dotColor, bgColor, k);
            },
            
            createGalaxyShader(params) {
                const colorInside = uniform(new THREE.Color(params.color));
                const colorOutside = uniform(new THREE.Color(params.background));
                
                // Simple galaxy pattern
                const center = vec3(0, 0, 0);
                const pos = positionGeometry;
                const dist = distance(pos, center);
                const angle = add(mul(time, 0.1), mul(dist, params.count));
                
                const spiral = add(cos(angle), sin(angle.mul(2))).mul(0.5).add(0.5);
                
                return mix(colorInside, colorOutside, spiral);
            },
            
            createSimplePattern(params) {
                const colorA = uniform(new THREE.Color(params.color));
                const colorB = uniform(new THREE.Color(params.background));
                
                // Simple checkerboard pattern
                const scale = uniform(params.count);
                const pos = positionGeometry.xy.mul(scale);
                const checker = add(pos.x.floor(), pos.y.floor()).mod(2);
                
                return mix(colorA, colorB, checker);
            },
            
            applyMaterial(material) {
                const mesh = this.el.getObject3D('mesh');
                if (mesh) {
                    mesh.material = material;
                    mesh.material.needsUpdate = true;
                } else {
                    this.el.addEventListener('object3dset', () => {
                        const newMesh = this.el.getObject3D('mesh');
                        if (newMesh) {
                            newMesh.material = material;
                            newMesh.material.needsUpdate = true;
                        }
                    });
                }
            },
            
            update() {
                this.setupMaterial();
            }
        });
    </script>
    
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        
        #info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
        }
        
        #controls {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
        }
        
        button {
            margin: 5px;
            padding: 8px 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <div id="info">
        <h3>ðŸŽ¨ TSL Shader Test</h3>
        <p>A-Frame WebGPU + TSL</p>
        <p>Using local Three.js files</p>
    </div>
    
    <div id="controls">
        <button onclick="changeShader('polka-dots')">Polka Dots</button>
        <button onclick="changeShader('galaxy')">Galaxy</button>
        <button onclick="changeShader('checkerboard')">Checkerboard</button>
    </div>

    <a-scene 
        stats 
        background="color: #201919">
        
        <!-- Main test sphere -->
        <a-sphere
            id="main-object"
            position="0 2 -5"
            radius="2"
            animation="property: rotation; to: 0 360 0; loop: true; dur: 20000"
            tsl-material="shader: polka-dots; count: 4; size: 0.6; blur: 0.2; color: #ff0000; background: #ffffff">
        </a-sphere>
        
        <!-- Test boxes -->
        <a-box 
            position="-3 1 -3" 
            rotation="0 45 0"
            tsl-material="shader: galaxy; count: 2; color: #ffa575; background: #311599">
        </a-box>
        
        <a-box 
            position="3 1 -3" 
            rotation="0 -45 0"
            tsl-material="shader: checkerboard; count: 6; color: #000000; background: #ffffff">
        </a-box>
        
        <!-- Ground -->
        <a-plane 
            position="0 0 0" 
            rotation="-90 0 0" 
            width="20" 
            height="20"
            color="#333333">
        </a-plane>
        
        <!-- Lighting -->
        <a-light type="ambient" color="#404040" intensity="0.4"></a-light>
        <a-light 
            type="directional" 
            color="#ffffff" 
            intensity="0.8" 
            position="5 5 2">
        </a-light>
        
        <!-- Camera -->
        <a-entity 
            position="0 2 5"
            camera="fov: 50; near: 0.1; far: 100"
            look-controls
            wasd-controls="acceleration: 20">
        </a-entity>
    </a-scene>
    
    <script>
        function changeShader(shaderType) {
            const mainObject = document.getElementById('main-object');
            mainObject.setAttribute('tsl-material', 'shader', shaderType);
            
            // Update colors based on shader type
            if (shaderType === 'galaxy') {
                mainObject.setAttribute('tsl-material', {
                    shader: shaderType,
                    color: '#ffa575',
                    background: '#311599'
                });
            } else if (shaderType === 'polka-dots') {
                mainObject.setAttribute('tsl-material', {
                    shader: shaderType,
                    color: '#ff0000',
                    background: '#ffffff'
                });
            } else {
                mainObject.setAttribute('tsl-material', {
                    shader: shaderType,
                    color: '#000000',
                    background: '#ffffff'
                });
            }
        }
    </script>
</body>
</html>