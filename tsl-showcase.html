<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>TSL Shader Carousel - A-Frame WebGPU</title>
    <meta name="description" content="TSL Textures with A-Frame WebGPU">
    
    <!-- Import maps for local Three.js WebGPU -->
    <script type="importmap">
    {
        "imports": {
            "aframe": "./components/three/aframe-master.module.min.js",
            "three": "./components/three/super-three.webgpu.js",
            "three/webgpu": "./components/three/super-three.webgpu.js",
            "three/tsl": "./components/three/super-three.tsl.js"
        }
    }
    </script>
    
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        
        #info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            max-width: 300px;
            z-index: 1000;
        }
        
        #controls {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
        }
        
        button {
            margin: 5px;
            padding: 8px 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <!-- Info Panel -->
    <div id="info">
        <h3>ðŸŽ¨ TSL Shader Carousel</h3>
        <p>A-Frame WebGPU with Three.js TSL Shaders</p>
        <p><strong>Current:</strong> <span id="current-shader">polka-dots</span></p>
        <p><small>Use WASD + mouse to navigate</small></p>
    </div>
    
    <!-- Controls -->
    <div id="controls">
        <button onclick="cycleShader()">Next Shader</button>
        <button onclick="randomizeParams()">Randomize</button>
    </div>

    <a-scene 
        webgpu="true"
        renderer="colorManagement: true; antialias: true; physicallyCorrectLights: true;"
        stats
        vr-mode-ui="enabled: false">
        
        <!-- The main showcase object -->
        <a-icosahedron
            id="main-object"
            position="0 2 -5"
            radius="2"
            detail="2"
            animation="property: rotation; to: 0 360 0; loop: true; dur: 20000"
            tsl-shader="shader: polka-dots; count: 3; size: 0.6; blur: 0.22; color: #000000; background: #ffffff; roughness: 0.2; metalness: 0.1">
        </a-icosahedron>
        
        <!-- Sample objects with different shaders -->
        <a-box 
            position="-4 1 -3" 
            rotation="0 45 0"
            animation="property: rotation; to: 0 405 0; loop: true; dur: 15000"
            tsl-shader="shader: circles; count: 4; size: 0.4; blur: 0.15; color: #ff4444; background: #ffffff">
        </a-box>
        
        <a-sphere 
            position="4 1.5 -3" 
            radius="1"
            animation="property: position; to: 4 2.5 -3; dir: alternate; loop: true; dur: 3000"
            tsl-shader="shader: zebra-lines; count: 8; size: 0.3; blur: 0.1; color: #000000; background: #ffff00">
        </a-sphere>
        
        <a-cylinder 
            position="-2 0.5 -2" 
            radius="0.5" 
            height="1"
            tsl-shader="shader: tiger-fur; count: 2; size: 0.5; blur: 0.2; color: #ff8800; background: #000000">
        </a-cylinder>
        
        <a-cylinder 
            position="2 0.5 -2" 
            radius="0.5" 
            height="1"
            tsl-shader="shader: dalmatian-spots; count: 5; size: 0.8; blur: 0.3; color: #000000; background: #ffffff">
        </a-cylinder>
        
        <!-- Ground with marble texture -->
        <a-plane 
            position="0 0 0" 
            rotation="-90 0 0" 
            width="20" 
            height="20"
            tsl-shader="shader: marble; count: 1; size: 0.4; blur: 0.3; color: #444444; background: #cccccc; roughness: 0.8; metalness: 0.0">
        </a-plane>
        
        <!-- Sky -->
        <a-sky color="#87CEEB"></a-sky>
        
        <!-- Lighting -->
        <a-light type="ambient" color="#404040" intensity="0.4"></a-light>
        <a-light 
            type="directional" 
            color="#ffffff" 
            intensity="0.8" 
            position="5 5 2"
            shadow="cast: true">
        </a-light>
        
        <!-- Camera -->
        <a-entity id="cameraRig" position="0 2 5">
            <a-camera 
                look-controls="pointerLockEnabled: true"
                wasd-controls="acceleration: 20">
            </a-camera>
        </a-entity>
    </a-scene>

    <!-- TSL Component Script -->
    <script type="module">
        import AFRAME from 'aframe';
        import * as THREE from 'three';
        
        // Set up global THREE for A-Frame compatibility
        const THREE_GLOBAL = {};
        const copyKeys = [...Object.getOwnPropertyNames(THREE), ...Object.getOwnPropertySymbols(THREE)];
        for (const key of copyKeys) {
            const descriptor = Object.getOwnPropertyDescriptor(THREE, key) ?? { enumerable: true };
            Object.defineProperty(THREE_GLOBAL, key, {
                value: THREE[key],
                enumerable: descriptor.enumerable,
                configurable: true,
                writable: true
            });
        }
        window.THREE = THREE_GLOBAL;
        
        // Available shaders list
        const SHADERS = [
            'polka-dots', 'circles', 'zebra-lines', 'tiger-fur', 'dalmatian-spots',
            'marble', 'wood', 'rust', 'concrete', 'clouds', 'water-drops',
            'voronoi-cells', 'stars', 'grid', 'neon-lights', 'satin'
        ];
        
        let currentShaderIndex = 0;
        
        // TSL Shader Component
        AFRAME.registerComponent('tsl-shader', {
            schema: {
                shader: {type: 'string', default: 'polka-dots'},
                count: {type: 'number', default: 2},
                size: {type: 'number', default: 0.5},
                blur: {type: 'number', default: 0.25},
                color: {type: 'color', default: '#000000'},
                background: {type: 'color', default: '#ffffff'},
                roughness: {type: 'number', default: 0.5},
                metalness: {type: 'number', default: 0.0},
                flat: {type: 'number', default: 0}
            },
            
            init: function() {
                this.setupMaterial();
            },
            
            setupMaterial: async function() {
                const data = this.data;
                
                try {
                    // Import the TSL shader
                    const shaderPath = `./tsl/${data.shader}.js`;
                    const shaderModule = await import(shaderPath);
                    
                    // Convert kebab-case to camelCase for function name
                    const functionName = data.shader.replace(/-([a-z])/g, (g) => g[1].toUpperCase());
                    const shaderFunction = shaderModule[functionName];
                    
                    if (!shaderFunction) {
                        console.warn(`Shader function ${functionName} not found`);
                        return;
                    }
                    
                    // Create material
                    const material = new THREE.MeshStandardNodeMaterial({
                        roughness: data.roughness,
                        metalness: data.metalness,
                    });
                    
                    // Apply TSL shader
                    material.colorNode = shaderFunction({
                        count: data.count,
                        size: data.size,
                        blur: data.blur,
                        color: new THREE.Color(data.color),
                        background: new THREE.Color(data.background),
                        flat: data.flat
                    });
                    
                    // Apply to mesh
                    this.applyMaterial(material);
                    
                } catch (error) {
                    console.error('Error loading TSL shader:', error);
                }
            },
            
            applyMaterial: function(material) {
                const mesh = this.el.getObject3D('mesh');
                if (mesh) {
                    mesh.material = material;
                } else {
                    this.el.addEventListener('object3dset', () => {
                        const newMesh = this.el.getObject3D('mesh');
                        if (newMesh) {
                            newMesh.material = material;
                        }
                    });
                }
            },
            
            update: function() {
                this.setupMaterial();
            }
        });
        
        // Global functions for controls
        window.cycleShader = function() {
            currentShaderIndex = (currentShaderIndex + 1) % SHADERS.length;
            const newShader = SHADERS[currentShaderIndex];
            
            const mainObject = document.getElementById('main-object');
            mainObject.setAttribute('tsl-shader', 'shader', newShader);
            
            document.getElementById('current-shader').textContent = newShader;
        };
        
        window.randomizeParams = function() {
            const mainObject = document.getElementById('main-object');
            const randomColor = '#' + Math.floor(Math.random()*16777215).toString(16);
            const randomBg = '#' + Math.floor(Math.random()*16777215).toString(16);
            
            mainObject.setAttribute('tsl-shader', {
                count: Math.random() * 8 + 1,
                size: Math.random() * 0.8 + 0.2,
                blur: Math.random() * 0.4 + 0.1,
                color: randomColor,
                background: randomBg,
                roughness: Math.random() * 0.8 + 0.1,
                metalness: Math.random() * 0.5
            });
        };
        
    </script>
    
</body>
</html>